<!doctype html>
<html>

<head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-159379151-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-159379151-1');
    </script>

    <title>/ˈsɑːnərənt/</title>
    <script src="https://www.chartjs.org/dist/2.9.3/Chart.min.js"></script>
    <script src="https://www.chartjs.org/samples/latest/utils.js"></script>
    <style>
        body {
            font-family: Helvetica, sans-serif;
        }

        #content {
            padding-left: 10%;
            padding-right: 10%;
        }

        a {
            color: steelblue;
        }

        #header {
            display: flex;
            font-weight: bolder;
            justify-content: space-between;
            align-items: center;
            padding-left: 10%;
            padding-right: 10%;
        }

        #site-info {
            display: flex;
            flex-direction: column;
        }

        #site-title {
            font-size: 2em;
        }

        #site-tagline {
            font-size: 1em;
        }

        #header a:link {
            font-size: 1em;
            text-decoration: none;
        }

        #header a:hover {
            text-decoration: underline;
        }


        #site-links {
            display: flex;
            justify-content: space-around;
            width: 15%;
        }

        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }

        #chart {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50%;
        }

        #buttons {
            display: flex;
            justify-content: center;
            padding-top: 2%;
            color: steelblue;
        }

        button {
            font-size: large;
            color: steelblue;
            border-radius: 40em;
        }

        #instructions {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 2%;
        }
    </style>
</head>

<body id="content">

    <div id="header">
        <div id="site-info">
            <div id="site-title">Sonorant</div>
            <div id="site-tagline">Make novel words in IPA</div>
        </div>

        <div id="site-links">
            <div>
                <a href="https://medium.com/@pollockcolin/sonorant-io-81a738c7d03?sk=de71dfe03d40849ade7d52a7faf999d2"
                    target="_blank">About</a>
            </div>
            <div><a href="https://github.com/colinpollock/sonorant" target="_blank">Github</a></div>
        </div>
    </div>

    <div id="chart">
        <canvas id="canvas"></canvas>
    </div>

    <div id="buttons">
        <button id="resetData">Start Over</button>
        <button id="undoLast">Undo Last</button>
        <button id="playAudio">Play Audio</button>
    </div>

    <div id="instructions">
        <div style="font-weight: bold">Construct novel English words, one phoneme at a time!</div>
        <div>
            <ul>
                <li>Each phoneme is an English speech sound in IPA. Click <a href="http://www.ipachart.com/">here</a> to
                    learn about IPA.
                </li>
                <li>Your current word shows up between //. It's empty until you click a bar.</li>
                <li>The bars show how likely each phoneme is to come next, according to a language model (click About
                    for more info).
                <li>Click a bar to choose the next phoneme.</li>
                </li>
            </ul>
        </div>
    </div>

    <!-- TODO eventually: pull JS out and test it -->
    <script>
        const data = {
            labels: [],
            // Chart.js expects data to be in a list called `datasets`, but I only have one dataset
            // so I just refer to data.datasets[0] throughought the code.
            datasets: [{
                backgroundColor: Chart.helpers.color(window.chartColors.blue).alpha(0.75).rgbString(),
                borderColor: window.chartColors.blue,
                borderWidth: 1,
                data: []
            }],
            chosenPhonemes: [],

            // The Audio for the current pronunciation, which is set after calling the server.
            sound: null
        };

        window.onload = function () {
            var ctx = document.getElementById('canvas').getContext('2d');
            window.chart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    legend: { display: false, position: 'top' },
                    title: { display: true, fontSize: 50 },
                    scales: {
                        yAxes: [{ ticks: { beginAtZero: true }, scaleLabel: { display: true, labelString: 'Probability', fontSize: 15 } }],
                        xAxes: [{
                            ticks: { fontSize: 20, autoSkip: false },
                            scaleLabel: { display: true, labelString: 'Next Phoneme', fontSize: 15 }
                        }]
                    },
                    onClick: (event, activeElements) => {
                        // If the user doesn't click on one phoneme's bar then there's nothing to do.
                        if (activeElements.length == 0) {
                            return;
                        }
                        var chosenPhonemeIndex = activeElements[0]._index;
                        var chosenPhoneme = data.labels[chosenPhonemeIndex]

                        if (chosenPhoneme == '<END>') {
                            presentDoneWord();
                            resetData();
                        } else {
                            data.chosenPhonemes.push(chosenPhoneme);
                            updateChartDisplay();
                        }
                    }
                }
            });

            updateChartDisplay()
        };

        /*
         * Present the final word to the user.
         * Note this is just an alert right now, but will involve updating the chart to show the
         * full word.
         */
        function presentDoneWord() {
            playPronunciationAudio();
            alert("You made a word: " + makePronunciationString());
        }

        /*
         * Clear the chosen phonemes and redraw the chart.
         */
        function resetData() {
            data.chosenPhonemes = [];
            updateChartDisplay();
        }

        /*
         * Calls the language model service to get the distribution over the *next* phoneme and the
         * audio for the current pronunciation.
         */
        function getNextPhonemeDistribution(updateDisplayCallback, setAndplayAudioCallback) {
            var pronunciation = data.chosenPhonemes.join(' ');
            var url = "{{ server_sync_endpoint }}" + encodeURI(pronunciation);

            var xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var response = JSON.parse(this.responseText);
                    updateDisplayCallback(response.next_probabilities);
                    setAndPlayAudio(response.audio)
                }
            };
            xmlhttp.open("GET", url, true);
            xmlhttp.send();
        }

        /*
         * Calls the language model service to get the probability distribution over the vocabulary
         * for the next phoneme in the sequence and also the audio for the current pronunciation.
         * The audio is then played and the chart is updated showing the new distribution.
         */
        function updateChartDisplay() {
            function updateDisplay(phonemeDistribution) {
                data.labels = [];
                data.datasets[0].data = [];

                for (var index in phonemeDistribution) {
                    [phoneme, probability] = phonemeDistribution[index];
                    data.labels.push(phoneme);
                    data.datasets[0].data.push(probability);
                }

                chart.options.title.text = makePronunciationString();
                window.chart.update();
            }

            getNextPhonemeDistribution(updateDisplay, setAndPlayAudio);
        }

        function setAndPlayAudio(b64audio) {
            data.sound = new Audio("data:audio/wav;base64," + b64audio);
            playPronunciationAudio();
        }

        function playPronunciationAudio() {
            data.sound.play();
        }

        /* Return a readable IPA string. */
        function makePronunciationString() {
            return '/' + data.chosenPhonemes.join('') + '/'
        }

        document.getElementById('resetData').addEventListener('click', function () {
            resetData();
        });

        document.getElementById('undoLast').addEventListener('click', function () {
            data.chosenPhonemes.pop();
            updateChartDisplay();
        });

        document.getElementById('playAudio').addEventListener('click', function () {
            playPronunciationAudio();
        });

    </script>
</body>

</html>
